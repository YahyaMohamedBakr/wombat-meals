{% comment %} {%- style -%}
  #wombat-popup-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.7); display: none; 
    justify-content: center; align-items: center; z-index: 999999;
  }
  .wombat-popup-content {
    background: {{ section.settings.bg_color }}; padding: 40px;
    border-radius: {{ section.settings.border_radius }}px;
    max-width: 450px; width: 90%; position: relative; text-align: center;
  }
  .wombat-popup-form button {
    width: 100%; padding: 12px; background: {{ section.settings.btn_color }};
    color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;
  }
  .success-banner {
    background: #f9f9f9; padding: 20px; border-radius: 10px;
    border: 1px dashed {{ section.settings.btn_color }}; color: #333;
  }
{%- endstyle -%}

<div id="wombat-popup-overlay">
  <div class="wombat-popup-content">
    <span class="wombat-close-popup" onclick="closeWombatPopup()" style="position:absolute; top:15px; right:20px; cursor:pointer;">&times;</span>
    
    {%- form 'customer', id: 'ContactPopup' -%}
      {%- if form.posted_successfully? -%}
        <h2>{{ section.settings.success_title }}</h2>
        <div class="success-banner">
          {{ section.settings.success_message }}
        </div>
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('wombat-popup-overlay').style.display = 'flex';
            localStorage.setItem('wombat_promo_claimed', 'true');
          });
        </script>
      {%- else -%}
        <h2>{{ section.settings.title }}</h2>
        <p>{{ section.settings.text }}</p>
        <div class="wombat-popup-form">
          <input type="hidden" name="contact[tags]" value="newsletter, WMB10_claimed">
          <input type="email" name="contact[email]" placeholder="Enter your email" required style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid #ddd;">
          <button type="submit">{{ section.settings.btn_text }}</button>
        </div>
      {%- endif -%}
    {%- endform -%}
  </div>
</div>

<script>
  function closeWombatPopup() { document.getElementById('wombat-popup-overlay').style.display = 'none'; }

  window.addEventListener('load', function() {
    const hasClaimed = localStorage.getItem('wombat_promo_claimed');
    const isPostSuccess = window.location.href.includes('customer_posted=true');

    if (!hasClaimed && !isPostSuccess) {
      setTimeout(function() {
        document.getElementById('wombat-popup-overlay').style.display = 'flex';
      }, 8000);
    }
  });
</script>

{% schema %}
{
  "name": "Wombat Promo Popup",
  "settings": [
    { "type": "text", "id": "title", "label": "Popup Title", "default": "Wait! Don't Miss Out" },
    { "type": "textarea", "id": "text", "label": "Popup Text", "default": "Sign up and get 10% off your first order." },
    { "type": "text", "id": "btn_text", "label": "Button Text", "default": "GET MY 10% OFF" },
    { "type": "header", "content": "Success State" },
    { "type": "text", "id": "success_title", "label": "Success Title", "default": "Check Your Inbox!" },
    { "type": "html", "id": "success_message", "label": "Success HTML (Coupon)", "default": "Your code is: <strong>WMB10</strong>. We also sent it to your email!" },
    { "type": "header", "content": "Styles" },
    { "type": "color", "id": "bg_color", "label": "Background", "default": "#ffffff" },
    { "type": "color", "id": "btn_color", "label": "Button Color", "default": "#ff840b" },
    { "type": "range", "id": "border_radius", "label": "Corners", "min": 0, "max": 30, "default": 15 }
  ]
}
{% endschema %} {% endcomment %}